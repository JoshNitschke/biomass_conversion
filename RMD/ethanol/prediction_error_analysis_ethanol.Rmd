---
title: "prediction error"
author: "Josh Nitschke"
date: "2023-10-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(skimr)
library(purrr)
library(tidyr)

```

# Wet mass as a predictor of dry mass

## Reading in cleaned data

```{r}
biomass_ethanol_wm_dm_cleaned <- read_csv(here("data/processed/ethanol/wm_dm/biomass_ethanol_wm_dm_cleaned.csv"))
```

### Regression summary statistics

Excluding outliers, running linear regressions on log-transformed data, and pulling out regression summary statistics

```{r}
# Getting coefficients from lm
taxa_nested_lm_ln_coef_ethanol_wm_dm <- biomass_ethanol_wm_dm_cleaned |>
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(lm_ln_object = map(.x = data,
                         .f = ~ lm(log(dm_g) ~ log(wm_g), data = .x)),
         summary = map(.x = lm_ln_object,
                       .f = ~ summary(.x)))
long_summary_ethanol_wm_dm <- taxa_nested_lm_ln_coef_ethanol_wm_dm |>
  mutate(coefs = map(.x = summary,
                            ~.x[[4]]),
         r2 = map(.x = summary,
                            ~.x[[9]]),
         n = map(.x = lm_ln_object,
                 ~length(.x$residuals))) |>
  unnest(c(coefs, r2, n)) |>
  mutate(coef_type = c(rep(c("intercept", "slope"), times = length(taxa_clean)/2))) |>
  pivot_wider(names_from = coef_type, values_from = coefs)

intercept <- long_summary_ethanol_wm_dm$intercept[,1]
intercept_se <- long_summary_ethanol_wm_dm$intercept[,2]
slope <- long_summary_ethanol_wm_dm$slope[,1]
slope_se <- long_summary_ethanol_wm_dm$slope[,2]
p <- long_summary_ethanol_wm_dm$slope[,4] # p-value of the slope is the same as the p-vale of the overall regression model in the case of simple regression with one predictor
long_summary_ethanol_wm_dm_short <- long_summary_ethanol_wm_dm |>
  select(taxa_clean, n, r2)
  
reg_summary_ethanol_wm_dm <- add_column(long_summary_ethanol_wm_dm_short, tibble(intercept, intercept_se, slope, slope_se, p))

# Back-transforming intercept to get parameter 'a' in power equation: y = ax^b
reg_summary_ethanol_wm_dm_a <- reg_summary_ethanol_wm_dm |> 
  mutate(a = exp(intercept))
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_lm_ln_coef_sf_ethanol_wm_dm <- taxa_nested_lm_ln_coef_ethanol_wm_dm |>
  mutate(sf = map(.x = lm_ln_object,
                  .f = ~ (1/length(residuals(.x)))*sum(exp(residuals(.x)))))

taxa_sf_ethanol_wm_dm <- taxa_nested_lm_ln_coef_sf_ethanol_wm_dm |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to lm summary table
reg_summary_ethanol_wm_dm_a_sf <- merge(reg_summary_ethanol_wm_dm_a, taxa_sf_ethanol_wm_dm)

```

### Calculating biomass ratios and associated summary statistics (outliers excluded)

```{r}
biomass_ethanol_wm_dm_cleaned_ratios <- biomass_ethanol_wm_dm_cleaned |>
  filter(keep_data == TRUE) |>
  mutate(dm_wm = dm_g/wm_g) |>
  group_by(taxa_clean) |>
  summarise(n = n(),
            mean_dm_wm = mean(dm_wm),
            sd_dm_wm = sd(dm_wm),
            lower_ci_mean_dm_wm = mean_dm_wm-0.95*(sd_dm_wm/sqrt(n)),
            upper_ci_mean_dm_wm = mean_dm_wm+0.95*(sd_dm_wm/sqrt(n)),
            geom_mean = prod(dm_wm)^(1/n),
            min_dm_wm = min(dm_wm),
            median_dm_wm = median(dm_wm),
            max_dm_wm = max(dm_wm))
```

## Comparing error in predicted mass for regression and ratio methods

```{r cars}
# published mean ratios from Ricciardi and Bourget (1998)
ricciardi_bourget <- tibble(taxa_clean = reg_summary_ethanol_wm_dm_a_sf$taxa_clean, ricc_bourg_mean_ratio = c(0.207, mean(0.61, 0.46, 0.519, 0.74), 0.199, NA, 0.515, 0.515, NA, 0.197, NA))

# calculating error in total predicted mass as a percentage of total measured mass
pred_mass_ethanol_wm_dm <- taxa_nested_lm_ln_coef_sf_ethanol_wm_dm |>
  left_join(reg_summary_ethanol_wm_dm_a) |>
  left_join(ricciardi_bourget) |>
  mutate(total_dm = map(.x = data,
                        .f = ~sum(.x$dm_g)),
         reg_pred_dm = pmap(.l = list(data, a, slope, sf),
                            .f = ~ sum(..2*(..1$wm_g)^..3)*..4),
         reg_pred_dm_percent_error = map2(.x = total_dm,
                                          .y = reg_pred_dm,
                                          .f = ~-((.x-.y)/.x)*100),
         ratio_pred_dm = map2(.x = data,
                              .y = biomass_ethanol_wm_dm_cleaned_ratios$mean_dm_wm,
                              .f = ~ sum(.y*.x$wm_g)),
         ratio_pred_dm_percent_error = map2(.x = total_dm,
                                          .y = ratio_pred_dm,
                                          .f = ~-((.x-.y)/.x)*100),
         riccbourg_ratio_pred_dm = map2(.x = data,
                              .y = ricc_bourg_mean_ratio,
                              .f = ~ sum(.y*.x$wm_g)),
         riccbourg_ratio_pred_dm_percent_error = map2(.x = total_dm,
                                          .y = riccbourg_ratio_pred_dm,
                                          .f = ~-((.x-.y)/.x)*100))
         
pred_mass_ethanol_wm_dm_error <- pred_mass_ethanol_wm_dm |>
  select(taxa_clean, total_dm, reg_pred_dm, reg_pred_dm_percent_error, 
         ratio_pred_dm, ratio_pred_dm_percent_error, riccbourg_ratio_pred_dm, 
         riccbourg_ratio_pred_dm_percent_error) |>
  unnest(cols = c(total_dm, reg_pred_dm, reg_pred_dm_percent_error, 
                  ratio_pred_dm, ratio_pred_dm_percent_error, riccbourg_ratio_pred_dm, 
                  riccbourg_ratio_pred_dm_percent_error))

pred_mass_ethanol_wm_dm_error_long <- pred_mass_ethanol_wm_dm_error |>
  select(taxa_clean, reg_pred_dm_percent_error, ratio_pred_dm_percent_error, riccbourg_ratio_pred_dm_percent_error) |>
  pivot_longer(cols = c(reg_pred_dm_percent_error, ratio_pred_dm_percent_error, riccbourg_ratio_pred_dm_percent_error), names_to = "pred_method", values_to = "percent_error")
  
ggplot(data = pred_mass_ethanol_wm_dm_error_long, aes(x = pred_method, y = percent_error)) +
  geom_jitter(width = 0.1, size = 3, aes(colour = taxa_clean), alpha = 0.5, stroke = 1) + 
  geom_hline(yintercept = 0, linetype = 2) +
  ggtitle("wet mass -> dry mass") +
  labs(x = "prediction method", y = "percentage error in total mass") +
  scale_x_discrete(labels = c("mean ratio", "log-linear regression", "Ricciardi and Bourget mean ratio")) +
    theme_bw() +
    theme(panel.border = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), 
          axis.line = element_line(colour = "black"),
          axis.text = element_text(size = 12, colour = "black"), 
          axis.title = element_text(size = 14))

```

# individual count as a predictor of wet mass

## Reading in cleaned data

```{r}
biomass_ethanol_count_wm_cleaned <- read_csv(here("data/processed/ethanol/count_wm/biomass_ethanol_count_wm_cleaned.csv"))
```

### Regression summary statistics

Excluding outliers, running linear regressions on log-transformed data, and pulling out regression summary statistics

```{r}
# Getting coefficients from lm
taxa_nested_lm_ln_coef_ethanol_count_wm <- biomass_ethanol_count_wm_cleaned |>
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(lm_ln_object = map(.x = data,
                            .f = ~ lm(log(wm_g) ~ log(individual_count), data = .x)),
         summary = map(.x = lm_ln_object,
                       .f = ~ summary(.x)))
long_summary_ethanol_count_wm <- taxa_nested_lm_ln_coef_ethanol_count_wm |>
  mutate(coefs = map(.x = summary,
                     ~.x[[4]]),
         r2 = map(.x = summary,
                  ~.x[[9]]),
         n = map(.x = lm_ln_object,
                 ~length(.x$residuals))) |>
  unnest(c(coefs, r2, n)) |>
  mutate(coef_type = c(rep(c("intercept", "slope"), times = length(taxa_clean)/2))) |>
  pivot_wider(names_from = coef_type, values_from = coefs)

intercept <- long_summary_ethanol_count_wm$intercept[,1]
intercept_se <- long_summary_ethanol_count_wm$intercept[,2]
slope <- long_summary_ethanol_count_wm$slope[,1]
slope_se <- long_summary_ethanol_count_wm$slope[,2]
p <- long_summary_ethanol_count_wm$slope[,4] # p-value of the slope is the same as the p-vale of the overall regression model in the case of simple regression with one predictor
long_summary_ethanol_count_wm_short <- long_summary_ethanol_count_wm |>
  select(taxa_clean, n, r2)

reg_summary_ethanol_count_wm <- add_column(long_summary_ethanol_count_wm_short, tibble(intercept, intercept_se, slope, slope_se, p))

# Back-transforming intercept to get parameter 'a' in power equation: y = ax^b
reg_summary_ethanol_count_wm_a <- reg_summary_ethanol_count_wm |> 
  mutate(a = exp(intercept))
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_lm_ln_coef_sf_ethanol_count_wm <- taxa_nested_lm_ln_coef_ethanol_count_wm |>
  mutate(sf = map(.x = lm_ln_object,
                  .f = ~ (1/length(residuals(.x)))*sum(exp(residuals(.x)))))

taxa_sf_ethanol_count_wm <- taxa_nested_lm_ln_coef_sf_ethanol_count_wm |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to lm summary table
reg_summary_ethanol_count_wm_a_sf <- merge(reg_summary_ethanol_count_wm_a, taxa_sf_ethanol_count_wm)

```

### Calculating biomass ratios and associated summary statistics (outliers excluded)

```{r}
biomass_ethanol_count_wm_cleaned_ratios <- biomass_ethanol_count_wm_cleaned |>
  filter(keep_data == TRUE) |>
  mutate(wm_count = wm_g/individual_count) |>
  group_by(taxa_clean) |>
  summarise(n = n(),
            mean_wm_count = mean(wm_count),
            sd_wm_count = sd(wm_count),
            lower_ci_mean_wm_count = mean_wm_count-0.95*(sd_wm_count/sqrt(n)),
            upper_ci_mean_wm_count = mean_wm_count+0.95*(sd_wm_count/sqrt(n)),
            geom_mean = prod(wm_count)^(1/n),
            min_wm_count = min(wm_count),
            median_wm_count = median(wm_count),
            max_wm_count = max(wm_count))
```

## Comparing error in predicted mass for regression and ratio methods

```{r cars}
pred_mass_ethanol_count_wm <- taxa_nested_lm_ln_coef_sf_ethanol_count_wm |>
  right_join(reg_summary_ethanol_count_wm_a) |>
  mutate(total_wm = map(.x = data,
                        .f = ~sum(.x$wm_g)),
         reg_pred_wm = pmap(.l = list(data, a, slope, sf),
                            .f = ~ sum(..2*(..1$individual_count)^..3)*..4),
         reg_pred_wm_percent_error = map2(.x = total_wm,
                                          .y = reg_pred_wm,
                                          .f = ~-((.x-.y)/.x)*100),
         ratio_pred_wm = map2(.x = data,
                              .y = biomass_ethanol_count_wm_cleaned_ratios$mean_wm_count,
                              .f = ~ sum(.y*.x$individual_count)),
         ratio_pred_wm_percent_error = map2(.x = total_wm,
                                            .y = ratio_pred_wm,
                                            .f = ~-((.x-.y)/.x)*100))

pred_mass_ethanol_count_wm_error <- pred_mass_ethanol_count_wm |>
  select(taxa_clean, total_wm, reg_pred_wm, reg_pred_wm_percent_error, 
         ratio_pred_wm, ratio_pred_wm_percent_error) |>
  unnest(cols = c(total_wm, reg_pred_wm, reg_pred_wm_percent_error, 
                  ratio_pred_wm, ratio_pred_wm_percent_error))

pred_mass_ethanol_count_wm_error_long <- pred_mass_ethanol_count_wm_error |>
  select(taxa_clean, reg_pred_wm_percent_error, ratio_pred_wm_percent_error) |>
  pivot_longer(cols = c(reg_pred_wm_percent_error, ratio_pred_wm_percent_error), names_to = "pred_method", values_to = "percent_error")

ggplot(data = pred_mass_ethanol_count_wm_error_long, aes(x = pred_method, y = percent_error)) +
  geom_jitter(width = 0.1, size = 3, fill = "grey", alpha = 0.5, stroke = 1) + 
  geom_hline(yintercept = 0, linetype = 2) +
  ggtitle("count -> wet mass") +
  labs(x = "prediction method", y = "percentage error in total mass") +
  scale_x_discrete(labels = c("mean ratio", "log-linear regression")) +
  theme_bw() +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 12, colour = "black"), 
        axis.title = element_text(size = 14))
```

# individual count as a predictor of dry mass

## Reading in cleaned data

```{r}
biomass_ethanol_count_dm_cleaned <- read_csv(here("data/processed/ethanol/count_dm/biomass_ethanol_count_dm_cleaned.csv"))
```

### Regression summary statistics

Excluding outliers, running linear regressions on log-transformed data, and pulling out regression summary statistics

```{r}
# Getting coefficients from lm
taxa_nested_lm_ln_coef_ethanol_count_dm <- biomass_ethanol_count_dm_cleaned |>
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(lm_ln_object = map(.x = data,
                            .f = ~ lm(log(dm_g) ~ log(individual_count), data = .x)),
         summary = map(.x = lm_ln_object,
                       .f = ~ summary(.x)))
long_summary_ethanol_count_dm <- taxa_nested_lm_ln_coef_ethanol_count_dm |>
  mutate(coefs = map(.x = summary,
                     ~.x[[4]]),
         r2 = map(.x = summary,
                  ~.x[[9]]),
         n = map(.x = lm_ln_object,
                 ~length(.x$residuals))) |>
  unnest(c(coefs, r2, n)) |>
  mutate(coef_type = c(rep(c("intercept", "slope"), times = length(taxa_clean)/2))) |>
  pivot_wider(names_from = coef_type, values_from = coefs)

intercept <- long_summary_ethanol_count_dm$intercept[,1]
intercept_se <- long_summary_ethanol_count_dm$intercept[,2]
slope <- long_summary_ethanol_count_dm$slope[,1]
slope_se <- long_summary_ethanol_count_dm$slope[,2]
p <- long_summary_ethanol_count_dm$slope[,4] # p-value of the slope is the same as the p-vale of the overall regression model in the case of simple regression with one predictor
long_summary_ethanol_count_dm_short <- long_summary_ethanol_count_dm |>
  select(taxa_clean, n, r2)

reg_summary_ethanol_count_dm <- add_column(long_summary_ethanol_count_dm_short, tibble(intercept, intercept_se, slope, slope_se, p))

# Back-transforming intercept to get parameter 'a' in power equation: y = ax^b
reg_summary_ethanol_count_dm_a <- reg_summary_ethanol_count_dm |> 
  mutate(a = exp(intercept))
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_lm_ln_coef_sf_ethanol_count_dm <- taxa_nested_lm_ln_coef_ethanol_count_dm |>
  mutate(sf = map(.x = lm_ln_object,
                  .f = ~ (1/length(residuals(.x)))*sum(exp(residuals(.x)))))

taxa_sf_ethanol_count_dm <- taxa_nested_lm_ln_coef_sf_ethanol_count_dm |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to lm summary table
reg_summary_ethanol_count_dm_a_sf <- merge(reg_summary_ethanol_count_dm_a, taxa_sf_ethanol_count_dm)

```

### Calculating biomass ratios and associated summary statistics (outliers excluded)

```{r}
biomass_ethanol_count_dm_cleaned_ratios <- biomass_ethanol_count_dm_cleaned |>
  filter(keep_data == TRUE) |>
  mutate(dm_count = dm_g/individual_count) |>
  group_by(taxa_clean) |>
  summarise(n = n(),
            mean_dm_count = mean(dm_count),
            sd_dm_count = sd(dm_count),
            lower_ci_mean_dm_count = mean_dm_count-0.95*(sd_dm_count/sqrt(n)),
            upper_ci_mean_dm_count = mean_dm_count+0.95*(sd_dm_count/sqrt(n)),
            geom_mean = prod(dm_count)^(1/n),
            min_dm_count = min(dm_count),
            median_dm_count = median(dm_count),
            max_dm_count = max(dm_count))
```

## Comparing error in predicted mass for regression and ratio methods

```{r cars}
pred_mass_ethanol_count_dm <- taxa_nested_lm_ln_coef_sf_ethanol_count_dm |>
  right_join(reg_summary_ethanol_count_dm_a) |>
  mutate(total_dm = map(.x = data,
                        .f = ~sum(.x$dm_g)),
         reg_pred_dm = pmap(.l = list(data, a, slope, sf),
                            .f = ~ sum(..2*(..1$individual_count)^..3)*..4),
         reg_pred_dm_percent_error = map2(.x = total_dm,
                                          .y = reg_pred_dm,
                                          .f = ~-((.x-.y)/.x)*100),
         ratio_pred_dm = map2(.x = data,
                              .y = biomass_ethanol_count_dm_cleaned_ratios$mean_dm_count,
                              .f = ~ sum(.y*.x$individual_count)),
         ratio_pred_dm_percent_error = map2(.x = total_dm,
                                            .y = ratio_pred_dm,
                                            .f = ~-((.x-.y)/.x)*100))

pred_mass_ethanol_count_dm_error <- pred_mass_ethanol_count_dm |>
  select(taxa_clean, total_dm, reg_pred_dm, reg_pred_dm_percent_error, 
         ratio_pred_dm, ratio_pred_dm_percent_error) |>
  unnest(cols = c(total_dm, reg_pred_dm, reg_pred_dm_percent_error, 
                  ratio_pred_dm, ratio_pred_dm_percent_error))

pred_mass_ethanol_count_dm_error_long <- pred_mass_ethanol_count_dm_error |>
  select(taxa_clean, reg_pred_dm_percent_error, ratio_pred_dm_percent_error) |>
  pivot_longer(cols = c(reg_pred_dm_percent_error, ratio_pred_dm_percent_error), names_to = "pred_method", values_to = "percent_error")

ggplot(data = pred_mass_ethanol_count_dm_error_long, aes(x = pred_method, y = percent_error)) +
  geom_jitter(width = 0.1, size = 3, fill = "grey", alpha = 0.5, stroke = 1) + 
  geom_hline(yintercept = 0, linetype = 2) +
  ggtitle("count -> dry mass") +
  labs(x = "prediction method", y = "percentage error in total mass") +
  scale_x_discrete(labels = c("mean ratio", "log-linear regression")) +
  theme_bw() +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 12, colour = "black"), 
        axis.title = element_text(size = 14))
```

