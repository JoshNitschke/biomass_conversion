---
title: "Prediction method comparison"
author: "Josh Nitschke"
date: "2023-08-31"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install.packages("remotes")
#remotes::install_github("traitecoevo/smatr")
#install.packages("cowplot")

library(tidyverse)
library(here)
library(smatr)
library(janitor)
library(skimr)
library(gridExtra)
library(olsrr)
library(purrr)
library(tidyr)
library(cowplot)

source(here("R/func/Xiao_et_al_2011_power_analysis_function.R"))
```

## Reading in cleaned data

```{r}
biomass_ethanol_wm_dm_cleaned <- read_csv(here("data/processed/ethanol/wm_dm/biomass_ethanol_wm_dm_cleaned.csv"))
```

## OLS

### Regression summary statistics

Excluding outliers, running linear regressions on log-transformed data, and pulling out regression summary statistics

```{r}
taxa_nested_outliers_removed_lm_ln_plot <- biomass_ethanol_wm_dm_cleaned |> 
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(lm_ln_object = map(.x = data,
                          ~ lm(log(dm_g) ~ log(wm_g), data = .x)))

# Getting coefficients from lm
taxa_nested_outliers_removed_lm_ln_plot_coef <- taxa_nested_outliers_removed_lm_ln_plot |>
  mutate(summary = map(.x = lm_ln_object,
                       .f = ~ summary(.x)))
long_summary_outliers_removed <- taxa_nested_outliers_removed_lm_ln_plot_coef |>
  mutate(coefs = map(.x = summary,
                            ~.x[[4]]),
         r2 = map(.x = summary,
                            ~.x[[9]]),
         n = map(.x = lm_ln_object,
                 ~length(.x$residuals))) |>
  unnest(c(coefs, r2, n)) |>
  mutate(coef_type = c(rep(c("intercept", "slope"), times = length(taxa_clean)/2))) |>
  pivot_wider(names_from = coef_type, values_from = coefs)

intercept <- long_summary_outliers_removed$intercept[,1]
intercept_se <- long_summary_outliers_removed$intercept[,2]
slope <- long_summary_outliers_removed$slope[,1]
slope_se <- long_summary_outliers_removed$slope[,2]
p <- long_summary_outliers_removed$slope[,4] # p-value of the slope is the same as the p-vale of the overall regression model in the case of simple regression with one predictor
long_summary_outliers_removed_short <- long_summary_outliers_removed |>
  select(taxa_clean, n, r2)
  
reg_summary_outliers_removed <- add_column(long_summary_outliers_removed_short, 
                                           tibble(intercept, intercept_se, slope, slope_se, p))

# Back-transforming intercept to get parameter 'a' in power equation: y = ax^b
reg_summary_outliers_removed_a <- reg_summary_outliers_removed |> 
  mutate(a = exp(intercept))
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_outliers_removed_lm_ln_plot_coef_sf <- taxa_nested_outliers_removed_lm_ln_plot_coef |>
  mutate(sf = map(.x = lm_ln_object,
                  .f = ~ (1/length(residuals(.x)))*sum(exp(residuals(.x)))))

taxa_outliers_removed_sf <- taxa_nested_outliers_removed_lm_ln_plot_coef_sf |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to lm summary table
reg_summary_outliers_removed_a_sf <- merge(reg_summary_outliers_removed_a, taxa_outliers_removed_sf)

# Saving the regression summary
write_csv(reg_summary_outliers_removed_a_sf,
          here("output/ethanol/wm_dm/biomass_regression_summary_ethanol_wm_dm_outliers_removed.csv"))
```

## SMA

### Regression summary statistics

Pulling out regression summary statistics

```{r}
# Getting coefficients from SMA
taxa_nested_sma_ln_coef_ethanol_wm_dm <- biomass_ethanol_wm_dm_cleaned |>
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(sma_ln_object = map(.x = data,
                         .f = ~ sma(log(dm_g) ~ log(wm_g), data = .x)),
         summary = map(.x = sma_ln_object,
                       .f = ~ (smatr:::summary.sma(.x))))

sma_summary_ethanol_wm_dm <- taxa_nested_sma_ln_coef_ethanol_wm_dm |> 
  select(taxa_clean, summary) |> 
  unnest(summary) |> 
  select(taxa_clean, n, r2, pval, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI)

# Back-transforming intercept and confidence intervals to get parameter 'a' in power equation: y = ax^b
sma_summary_ethanol_wm_dm_a <- sma_summary_ethanol_wm_dm |> 
  mutate(a = exp(Int))
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_sma_ln_coef_sf_ethanol_wm_dm <- taxa_nested_sma_ln_coef_ethanol_wm_dm |>
  mutate(sf = map(.x = sma_ln_object,
                  .f = ~ (1/length(residuals(.x)))*sum(exp(residuals(.x)))))

taxa_sf_sma_ethanol_wm_dm <- taxa_nested_sma_ln_coef_sf_ethanol_wm_dm |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to SMA summary table
sma_summary_ethanol_wm_dm_a_sf <- merge(sma_summary_ethanol_wm_dm_a,
                                            taxa_sf_sma_ethanol_wm_dm)

# Adding suffix to variable names for later identification
names(sma_summary_ethanol_wm_dm_a_sf) <- paste0(names(sma_summary_ethanol_wm_dm_a_sf), "_sma")
sma_summary_ethanol_wm_dm_a_sf <- rename(sma_summary_ethanol_wm_dm_a_sf, "taxa_clean" = "taxa_clean_sma") |>
  clean_names()
```

### Back-transformation 

Plotting back-transformed regression lines with smearing factor correction 

```{r}
# Extracting lower and upper 95% confidence bounds on the transformed scale
taxa_nested_outliers_removed_lm_ln_plot_coef_CI <- taxa_nested_outliers_removed_lm_ln_plot_coef_sf |> 
  mutate(conf_int = map(.x = lm_ln_object,
                        .f = ~ predict(.x, interval = "confidence"))) |>
  unnest(cols = c(data, sf, conf_int))

lower_CI <- taxa_nested_outliers_removed_lm_ln_plot_coef_CI$conf_int[,2]
upper_CI <- taxa_nested_outliers_removed_lm_ln_plot_coef_CI$conf_int[,3]

# Back-transforming confidence bounds and plotting with back-transformed regression line
taxa_nested_outliers_removed_lm_ln_plot_coef_CI_BT <- taxa_nested_outliers_removed_lm_ln_plot_coef_CI |>
  add_column(lower_CI, upper_CI) |>
  mutate(lower_CI_line = exp(lower_CI)*sf,
         upper_CI_line = exp(upper_CI)*sf) |>
  select(taxa_clean, wm_g, dm_g, lower_CI_line, upper_CI_line, sf) |>
  nest(data = c(wm_g, dm_g, lower_CI_line, upper_CI_line)) |>
  right_join(reg_summary_outliers_removed_a) |>
  right_join(sma_summary_ethanol_wm_dm_a_sf) |>
  mutate(BT_plot = pmap(.l = list(data, slope, intercept, sf, taxa_clean, r2, slope_sma, a_sma, sf_sma),
                        .f = ~ggplot(..1, aes(x = wm_g, y = dm_g)) +
                          geom_point(fill = "grey", size = 3, alpha = 0.5, stroke = 1) +
                          geom_function(fun = function(x) (exp(..3))*(x^..2)*..4, 
                                        col = "darkgreen", linewidth  = 1) +
                          #geom_function(fun = function(x) ..8*x^..7*..9,
                          #              col = "orange", linewidth  = 1) +
                          geom_function(fun = function(x) mean(..1$dm_g/..1$wm_g)*x,
                                        col = "purple", linewidth  = 1, linetype = 2) +
                         # geom_ribbon(aes(ymin = lower_CI_line, ymax = upper_CI_line),
                         # fill = "darkgreen", alpha = 0.2) +
                          ggtitle(..5) + 
                          labs(x = "wet mass (g)", y = "dry mass (g)") + 
                          #geom_text(x = 0.25*max(..1$wm_g), y = 0.85*max(..1$dm_g), 
                          #          label = deparse(bquote(paste("D = ", .(round(exp(..3), digits = 2)), 
                          #                                       "W" ^.(round(..2, digits = 2))* " \u00D7 ",
                          #                                       .(round(..4, digits = 2)), sep = ""))),
                          #          parse = TRUE, size = 4) +
                          #geom_text(x = 0.25*max(..1$wm_g), y = 0.75*max(..1$dm_g), 
                          #          label = deparse(bquote(paste("R"^2, " = ", .(round(..6, digits = 2)), 
                          #                                       sep = ""))),
                          #          parse = TRUE, size = 4) +
                          theme_bw() + 
                          theme(panel.border = element_blank(), 
                                panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank(), 
                                axis.line = element_line(colour = "black"),
                                axis.text = element_text(size = 12, colour = "black"), 
                                axis.title = element_text(size = 14), 
                                title = element_text(size = 16)) + 
                          scale_x_continuous(expand = expansion(mult = c(0, 0.1)), limits = c(0, NA)) + 
                          scale_y_continuous(expand = expansion(mult = c(0, 0.1)), limits = c(0, NA))))
taxa_nested_outliers_removed_lm_ln_plot_coef_CI_BT$BT_plot
```

Saving the Capitella plot as an example

```{r}

png(here("output/png/ethanol_wm_dm_ols_ratio_comparison.png"), width = 2000, height = 1400, res = 300)
par(omi = c(1,1,1,1))  
taxa_nested_outliers_removed_lm_ln_plot_coef_CI_BT$BT_plot[3]
dev.off()

```

### comparing with other published conversion factors

Ricciardi, A., and E. Bourget. 1998. Weight-to-weight conversion factors for marine benthic macroinvertebrates. Marine Ecology Progress Series 163:245-251.
```{r}
ricciardi_bourget <- tibble(taxa_clean = reg_summary_outliers_removed_a_sf$taxa_clean, ricc_bourg_mean_ratio = c(0.207, mean(0.61, 0.46, 0.519, 0.74), 0.199, NA, 0.515, 0.515, NA, 0.197, NA))

taxa_nested_outliers_removed_lm_ln_plot_coef_CI_BT_riccbourg <- taxa_nested_outliers_removed_lm_ln_plot_coef_CI |>
  add_column(lower_CI, upper_CI) |>
  mutate(lower_CI_line = exp(lower_CI)*sf,
         upper_CI_line = exp(upper_CI)*sf) |>
  select(taxa_clean, wm_g, dm_g, lower_CI_line, upper_CI_line, sf) |>
  nest(data = c(wm_g, dm_g, lower_CI_line, upper_CI_line)) |>
  right_join(reg_summary_outliers_removed_a) |>
  right_join(sma_summary_ethanol_wm_dm_a_sf) |>
  left_join(ricciardi_bourget) |>
  mutate(BT_plot = pmap(.l = list(data, slope, intercept, sf, taxa_clean, r2, slope_sma, a_sma, sf_sma, ricc_bourg_mean_ratio),
                        .f = ~ggplot(..1, aes(x = wm_g, y = dm_g)) +
                          geom_point(fill = "grey", size = 3, alpha = 0.5, stroke = 1) +
                          geom_function(fun = function(x) (exp(..3))*(x^..2)*..4, 
                                        col = "darkgreen", linewidth  = 1) +
                          #geom_function(fun = function(x) ..8*x^..7*..9,
                          #              col = "orange", linewidth  = 1) +
                          geom_function(fun = function(x) mean(..1$dm_g/..1$wm_g)*x,
                                        col = "purple", linewidth  = 1, linetype = 2) +
                          geom_function(fun = function(x) ..10*x,
                                        col = "red", linewidth  = 1, linetype = 2) +
                         # geom_ribbon(aes(ymin = lower_CI_line, ymax = upper_CI_line),
                         # fill = "darkgreen", alpha = 0.2) +
                          ggtitle(..5) + 
                          labs(x = "wet mass (g)", y = "dry mass (g)") + 
                          #geom_text(x = 0.25*max(..1$wm_g), y = 0.85*max(..1$dm_g), 
                          #          label = deparse(bquote(paste("D = ", .(round(exp(..3), digits = 2)), 
                          #                                       "W" ^.(round(..2, digits = 2))* " \u00D7 ",
                          #                                       .(round(..4, digits = 2)), sep = ""))),
                          #          parse = TRUE, size = 4) +
                          #geom_text(x = 0.25*max(..1$wm_g), y = 0.75*max(..1$dm_g), 
                          #          label = deparse(bquote(paste("R"^2, " = ", .(round(..6, digits = 2)), 
                          #                                       sep = ""))),
                          #          parse = TRUE, size = 4) +
                          theme_bw() + 
                          theme(panel.border = element_blank(), 
                                panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank(), 
                                axis.line = element_line(colour = "black"),
                                axis.text = element_text(size = 12, colour = "black"), 
                                axis.title = element_text(size = 14), 
                                title = element_text(size = 16)) + 
                          scale_x_continuous(expand = expansion(mult = c(0, 0.1)), limits = c(0, NA)) + 
                          scale_y_continuous(expand = expansion(mult = c(0, 0.1)), limits = c(0, NA))))
taxa_nested_outliers_removed_lm_ln_plot_coef_CI_BT_riccbourg$BT_plot
```
