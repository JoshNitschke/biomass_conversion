---
title: "Using smatr"
author: "Josh and Fonti"
date: "2023-07-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install.packages(c("here"))
library(tidyverse)
library(here)
library(skimr)

```

## Using RMD files

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

Alternativly, you can click on the green play button next to each chunk to run each chunk locally. 

You can embed an R code chunk like this:

```{r, eval=FALSE}
biomass_data <- read_csv("data/biomass_conversions.csv")
```

One _very_ minor caveat of RMD is that they mess up file paths in a R project.

```{r bad RMD, echo=FALSE}
knitr::include_graphics(here("output/png/RMD_filepath_error.png"), error=TRUE)
```

So we have to rely on the `here` R package to tell R/RMD where the heck we are working from. Run this code chunk to install and load the `here`

```{r, eval=FALSE}
install.packages("here")

library(here)
```

The `here()` function will spit out the absolute file path to your project without you having to type it out. 

```{r}
here()
```

### Read in data

We can use it in RMD code chunks so we can read in data and images smoothly! 

Also noticed I am used `read_csv()`? `read_csv()` is the tidyverse cousin of `read.csv()`. The benefit of using this version is a much tidier output!

```{r, warning=FALSE}
biomass_data <- read_csv(here("data/biomass_conversions.csv"))
```

### Overview of data

```{r}
str(biomass_data)
skim(biomass_data)
```

### Filter Frozen Samples

```{r}
biomass_data_frozen <- biomass_data %>%
  filter(`Preservation Method` == "Frozen")
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

### Install smatr

Have a go installing `smatr` from [CRAN](https://cran.r-project.org/). CRAN is where all R packages live but generally the version on CRAN is not the latest version of the package 

```{r, eval=FALSE}
# install.packages("smatr")
```

Now try install the 'active development' version from [GitHub](https://github.com/traitecoevo/smatr). As the maintainer of `smatr` I suggest working off this version as we fixed some pretty big bugs that are not yet updated on CRAN! 

You will probably need to uncomment the `install.packages("remotes")` line and install `remotes` first.

```{r, eval=FALSE}
# install.packages("remotes")
remotes::install_github("traitecoevo/smatr")

library(smatr)
```

Frozen samples: 
Dry mass
Wet mass
Individual counts

- Determine slope and intercept 
- DM - WM
- DM - Counts
- WM - Counts

```{r}
leaf.low <- subset(leaflife, soilp == 'low' & rain == 'low')

ma <- ma(longev ~ lma, data=leaf.low) 

plot(ma)
```

## Data exploration plots

Some historgrams

Untransformed data looks quite right skewed (long right tail) - suggests transformation needed because wide range of data, lots small values, not a lot of big values

```{r}
hist(biomass_data_frozen$`DM (g)`)
hist(biomass_data_frozen$`WM (g)`)
hist(biomass_data_frozen$`raw individual count`)
```

Attempting to log raw data

`Removed 476 rows containing non-finite values`
```{r}
library(ggplot2)

# Log scale
log10(1)
log10(10)
log10(100)
log10(1000)

# Log tranformed
ggplot(biomass_data_frozen, aes(x = `DM (g)`)) + 
  geom_histogram() + 
  scale_x_log10()
```

# Investigate those 476 values

Fonti to investigate how to get these values - WHICH ONE ARE THEY! 

```{r}
biomass_data_frozen_withlog <- biomass_data_frozen |> 
  mutate(logDM_g = log10(`DM (g)`))

hist(biomass_data_frozen_withlog$logDM_g, breaks = 30)

ggplot(biomass_data_frozen_withlog, aes(x = logDM_g)) + 
  geom_histogram() 
```

# Excluding tiny values

```{r}
# This filters the tiny values
biomass_data_frozen |> 
  filter(`DM (g)` < 0.001) |> 
  select(`DM (g)`)

# This filters the inverse/opposite e.g. we want to exclude the tiny values
biomass_data_frozen |> 
  filter(! `DM (g)` < 0.001) |> 
  select(`DM (g)`) # Check values
  
# Assign to a new data object 
biomass_frozen_notiny_logged <- biomass_data_frozen |> 
  filter(! `DM (g)` < 0.001)  |>
  mutate(log10_DM_g = log10(`DM (g)`), 
         log10_WM_g = log10(`WM (g)`))
```

# Clean up variable names 

R doesn't like spaces in varaible names

```{r}
#install.packages("janitor")
library(janitor)

cleannamed_frozen_notiny_logged <- biomass_frozen_notiny_logged |> clean_names()

colnames(cleannamed_frozen_notiny_logged)
```

## Our first sma! 

```{r}
# Raw untransformed 
untransformed_sma <- cleannamed_frozen_notiny_logged |> 
  select(dm_g, wm_g) |> 
  sma(method = "SMA")

untransformed_sma

plot(untransformed_sma)

# Verifying with example data that hack is ok
sma(longev ~ lma, data=leaf.low)

leaf.low |> 
  select(longev, lma) |> 
  sma()

# data argument not working hacking up
# untransformed_sma <- sma(dm_g, wm_g, data = cleannamed_frozen_notiny_logged)

# Log transform with smatr CAUTIO
log_sma <- cleannamed_frozen_notiny_logged |> 
  select(dm_g, wm_g) |> 
  sma(method = "SMA", log = "xy")

plot(log_sma)

# Warning message:
# In sma(select(cleannamed_frozen_notiny_logged, dm_g, wm_g), method = "SMA",  :
#   Deleted negative and/or zero values in X variable.

# Log transform ourselves _ NOT WORKING!
hist(cleannamed_frozen_notiny_logged$log10_dm_g)
hist(cleannamed_frozen_notiny_logged$log10_wm_g)

diy_log_sma <- cleannamed_frozen_notiny_logged |> 
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")

```

<!-- https://math.stackexchange.com/questions/2018673/what-does-the-slope-of-a-log-log-plot-represent -->

y = m(x) + c
y = slope(x) + intercept
y = B1(x) + B0

log(DM) = log(WM)
log(DM) =  slope(logWM) + log(intercept) 

# Log Addition rule 1
log(WM x intercept)  = log(WM) + log(intercept)

# Log multiplication rule 3
log(WM^slope) = slope(logWM)





# Explore taxa

```{r}
cleannamed_frozen_notiny_logged |> 
  pull(taxa) |> 
  tabyl() |> 
  arrange(-n)


# I know there must be a better way to do this but was just curious to see what the log plots looked like for the main (most abundant) taxa. Tried group_by(taxa) without much luck...

# Amphipoda
# Raw untransformed 
untransformed_sma_amphipoda <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Amphipoda") |>
  select(dm_g, wm_g) |> 
  sma(method = "SMA")
untransformed_sma_amphipoda
plot(untransformed_sma_amphipoda)

# log10 transformed
log10_sma_amphipoda <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Amphipoda") |>
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")
log10_sma_amphipoda
plot(log10_sma_amphipoda)

# Arthritica
# Raw untransformed 
untransformed_sma_arthritica <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Arthritica") |>
  select(dm_g, wm_g) |> 
  sma(method = "SMA")
untransformed_sma_arthritica
plot(untransformed_sma_arthritica)

# log10 transformed
log10_sma_arthritica <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Arthritica") |>
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")
log10_sma_arthritica
plot(log10_sma_arthritica)

# Capitella
# Raw untransformed 
untransformed_sma_capitella <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Capitella") |>
  select(dm_g, wm_g) |> 
  sma(method = "SMA")
untransformed_sma_capitella
plot(untransformed_sma_capitella)

# log10 transformed
log10_sma_capitella <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Capitella") |>
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")
log10_sma_capitella
plot(log10_sma_capitella)

# Simplisetia
# Raw untransformed 
untransformed_sma_simplisetia <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Simplisetia") |>
  select(dm_g, wm_g) |> 
  sma(method = "SMA")
untransformed_sma_simplisetia
plot(untransformed_sma_simplisetia)

# log10 transformed
log10_sma_simplisetia <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Simplisetia") |>
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")
log10_sma_simplisetia
plot(log10_sma_simplisetia)

# Chironomidae
# Raw untransformed 
untransformed_sma_chironomidae <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Chironomidae") |>
  select(dm_g, wm_g) |> 
  sma(method = "SMA")
untransformed_sma_chironomidae
plot(untransformed_sma_chironomidae)

# log10 transformed
log10_sma_chironomidae <- cleannamed_frozen_notiny_logged |> 
  filter(taxa == "Chironomidae") |>
  select(log10_dm_g, log10_wm_g) |> 
  sma(method = "SMA")
log10_sma_chironomidae
plot(log10_sma_chironomidae)
```


Eventually - compare with diff preservation methods