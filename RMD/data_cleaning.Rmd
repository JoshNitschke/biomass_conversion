---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(smatr)
library(janitor)
library(skimr)
library(gridExtra)
library(olsrr)
```


```{r, warning=FALSE}
biomass_data <- read_csv(here("data/biomass_conversions.csv"), na = c('#DIV/0!', 'NA'))
```

## Clean variable names

```{r}
biomass_data <- biomass_data |> clean_names() 
``` 

## Clean taxa

```{r}
# Table of counts
biomass_data$taxa |> tabyl()

# Correct typo and checking
biomass_data |> 
  mutate(taxa_clean = case_when(taxa == "salinator" ~ "Salinator",
                          TRUE ~ taxa)) |> 
  select(taxa, taxa_clean) |> 
  filter(taxa == "salinator")

# Making changes
biomass_data_taxaclean <- biomass_data |> 
  mutate(taxa_clean = case_when(taxa == "salinator" ~ "Salinator",
                          TRUE ~ taxa)) |> 
  filter(!taxa == "") # Dropping empty taxa

biomass_data_taxaclean$taxa_clean |> tabyl()
``` 

## minimum mass cut-off (due to higher proportional measurement error at very small mass values)

```{r}
biomass_data_taxaclean_mass_cutoff <- biomass_data_taxaclean |>
  filter(wm_g >= 0.001, dm_g >=0.001) 
```

## filter frozen samples only

```{r}
biomass_frozen_taxaclean_mass_cutoff <- biomass_data_taxaclean_mass_cutoff |>
  filter(preservation_method == "Frozen")
```

## Create observation number

```{r}
biomass_wobs <- biomass_frozen_taxaclean_mass_cutoff |> 
  mutate(obs_num = row_number())
```

## Outliers

Obs: 5747, 3859

```{r}
# A Clevaland plot
ggplot(biomass_wobs, aes(x = dm_g, y = obs_num, label = obs_num)) +
  geom_point(colour = "white") +
  geom_text() + 
  theme_bw()         
```


### Z score method

Z scores = (dm - mean(dm))/sd(dm)

Make clevaland plot for each speices and plot where their 3SD is using geom_vline
```{r}
mean_dm <- mean(biomass_wobs_z$dm_g, na.rm = TRUE)
sd_dm <- sd(biomass_wobs_z$dm_g, na.rm = TRUE)


biomass_wobs_z <- biomass_wobs  |> 
  mutate(z_dm = scale(dm_g, center = TRUE, scale = TRUE),
         centered_dm = scale(dm_g, center = TRUE, scale = FALSE),
         manual_z_dm = (dm_g-mean_dm)/sd_dm,
         manual_centered_dm = (dm_g-mean_dm)
  )

# An illustration of scale()
biomass_wobs_z |> 
  select(ends_with("dm"), -starts_with("af"))

# A Clevaland plot
ggplot(biomass_wobs_z, aes(x = z_dm, y = obs_num, label = obs_num)) +
  geom_point(colour = "white") +
  geom_text() + 
  geom_vline(xintercept = sd_dm*3, colour = "yellow") #After looking into z scores more, it seems like standard deviations is their unit, so the vline can be placed at 3 rather than 3*sd's of dm

summary(biomass_wobs_z$z_dm)
```

### By species
## Z scores
Compute z scores for dm and wm for each species 
```{r}

biomass_wobs_z <- biomass_wobs |>  
  group_by(taxa_clean) |> 
            mutate(z_dm = scale(dm_g, center = TRUE, scale = TRUE),
            z_wm = scale(wm_g, center = TRUE, scale = TRUE))

biomass_wobs_z |> ggplot(aes(x = z_dm, y = obs_num, label = obs_num)) +
  facet_wrap(~ taxa_clean, scale = "free") +
  geom_point(colour = "white") +
  geom_text() + 
  geom_vline(xintercept = 3, colour = "orange")

biomass_wobs_z |> ggplot(aes(x = z_wm, y = obs_num, label = obs_num)) +
  facet_wrap(~ taxa_clean, scale = "free") +
  geom_point(colour = "white") +
  geom_text() + 
  geom_vline(xintercept = 3, colour = "orange")
```

## Percentiles (2.5 and 97.5)
```{r}

biomass_percentiles <- biomass_wobs_z |>  
  summarize("wm_2.5_percentile" = quantile(wm_g, 0.025, na.rm = TRUE),
            "wm_97.5_percentile" = quantile(wm_g, 0.975, na.rm = TRUE),
            "dm_2.5_percentile" = quantile(dm_g, 0.025, na.rm = TRUE),
            "dm_97.5_percentile" = quantile(dm_g, 0.975, na.rm = TRUE))
biomass_percentiles
         
biomass_frozen_percentiles_removed <- biomass_wobs_z |>
 mutate(wm_g_trimmed = ifelse(wm_g >= quantile(wm_g, 0.025, na.rm = TRUE) & wm_g <= quantile(wm_g, 0.975, na.rm = TRUE), wm_g, NA),
        dm_g_trimmed = ifelse(dm_g >= quantile(dm_g, 0.025, na.rm = TRUE) & dm_g <= quantile(dm_g, 0.975, na.rm = TRUE), dm_g, NA))

#trying to check if trimming worked properly
biomass_frozen_percentiles_removed |>
  summarize(wm_g_min = min(wm_g, na.rm = TRUE),
            wm_g_max = max(wm_g, na.rm = TRUE),
            wm_g_trimmed_min = min(wm_g_trimmed, na.rm = TRUE),
            wm_g_trimmed_max = max(wm_g_trimmed, na.rm = TRUE))

# testing more efficient method of above
biomass_frozen_percentiles_removed |>
  summarize_at(vars("wm_g", "wm_g_trimmed"), funs(min = min(., na.rm = TRUE),
            max = max(., na.rm = TRUE)))

# still trying to check if trimming worked properly
biomass_frozen_percentiles_removed|>
  summarise(wm_g_trimmed_na = sum(is.na(wm_g_trimmed)),
            wm_g_trimmed_na_pct = sum(is.na(wm_g_trimmed))/n(),
            dm_g_trimmed_na = sum(is.na(dm_g_trimmed)),
            dm_g_trimmed_na_pct = sum(is.na(dm_g_trimmed))/n()) |>
  print(n = 30)
               
```

## Cooks Distance

Cook statistic in linear regression

```{r}
#OLS regression of dm~wm for Amphipoda
amphipoda_ols_data <- biomass_frozen_percentiles_removed |>
  filter(taxa_clean == "Amphipoda")

amphipoda_ols <- lm(dm_g~wm_g, data = amphipoda_ols_data)
summary(amphipoda_ols)

ggplot(amphipoda_ols, aes(x = dm_g, y= wm_g)) +
  geom_point(alpha = 0.50) + stat_smooth(method = "lm")

#cook's distance based on the OLS regression
cooks.distance(amphipoda_ols)

#filtering outliers based on threshold value of cook's D, i.e. critical value from F distribution, as per Aguinis et al. (2013)  
biomass_frozen_outliers_amphipoda <- biomass_frozen_percentiles_removed |>
  filter(taxa_clean == "Amphipoda") |>
  mutate(cooks_d = cooks.distance(amphipoda_ols)) |>
  filter(cooks_d >= qf(0.5, 2, 224, lower.tail = FALSE))
biomass_frozen_outliers_amphipoda |>
  select(wm_g, dm_g, cooks_d)

biomass_frozen_outliers_removed_amphipoda <- biomass_frozen_percentiles_removed |>
  filter(taxa_clean == "Amphipoda") |>
  mutate(cooks_d = cooks.distance(amphipoda_ols)) |>
  filter(cooks_d < qf(0.5, 2, 224, lower.tail = FALSE))
biomass_frozen_outliers_removed_amphipoda |>
  select(wm_g, dm_g, cooks_d) |>
  arrange(desc(cooks_d))

#plot of cook's D
ols_plot_cooksd_bar(amphipoda_ols)

```

