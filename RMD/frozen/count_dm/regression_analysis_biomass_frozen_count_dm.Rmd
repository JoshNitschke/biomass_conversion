---
title: "SMA regression analysis"
author: "Josh Nitschke"
date: "2023-08-31"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install.packages("remotes")
remotes::install_github("traitecoevo/smatr")

library(tidyverse)
library(here)
library(smatr)
library(janitor)
library(skimr)
library(gridExtra)
library(olsrr)
library(purrr)
library(tidyr)

source(here("R/func/Xiao_et_al_2011_power_analysis_function.R"))
```

## Reading in cleaned data

```{r}
biomass_frozen_count_dm_cleaned <- read_csv(here("data/processed/frozen/count_dm/biomass_frozen_count_dm_cleaned.csv"))
```

## Running SMA's on untransformed data

```{r}
taxa_nested_sma <- biomass_frozen_count_dm_cleaned |> 
  group_nest(taxa_clean) |>
  mutate(sma_object = map(.x = data,
                          ~ sma(dm_g ~ individual_count, data = .x)))
```

### Checking assumptions

#### Homogeneity of variance

```{r}
taxa_nested_sma_fitted_resid <- taxa_nested_sma |> 
  mutate(fitted_resid = map(.x = sma_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0, linetype = 2) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_sma_fitted_resid$fitted_resid_plot
```

#### Normality

```{r}
taxa_nested_sma_fitted_resid_qq <- taxa_nested_sma_fitted_resid |>
  mutate(qq = map2(.x = sma_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
```

## Excluding outliers

### Running SMA's on untransformed data

```{r}
taxa_nested_sma_outliers_removed <- biomass_frozen_count_dm_cleaned |> 
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(sma_object = map(.x = data,
                          ~ sma(dm_g ~ individual_count, data = .x)))
```

### Checking assumptions

#### Homogeneity of variance

```{r}
taxa_nested_sma_outliers_removed_fitted_resid <- taxa_nested_sma_outliers_removed |> 
  mutate(fitted_resid = map(.x = sma_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0, linetype = 2) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_sma_outliers_removed_fitted_resid$fitted_resid_plot
```

#### Normality

```{r}
taxa_nested_sma_outliers_removed_fitted_resid_qq <- taxa_nested_sma_outliers_removed_fitted_resid |>
  mutate(qq = map2(.x = sma_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
```

## Testing error structure

Testing the error structure of the data to see whether non-linear (additive error) or log-normal (multiplicative error) models are more appropriate, using code from Xiao, X., E. P. White, M. B. Hooten and S. L. Durham. On the use of log-transformation vs. nonlinear regression for analyzing biological power laws. Ecology, 92, 1887-1894 (2011).

```{r}
taxa_nested_power_analysis_check <- biomass_frozen_count_dm_cleaned |> 
  group_nest(taxa_clean) |>
  mutate(power_analysis_test = map(.x = data,
                          ~ power_analysis(.x$individual_count, .x$dm_g)))
```

## Log-transforming to stabilise variance and improve normality

### Running SMA's on log10-transformed data and plotting

```{r}
taxa_nested_sma_log10_plot <- biomass_frozen_count_dm_cleaned |> 
  group_nest(taxa_clean) |>
  mutate(sma_log10_object = map(.x = data,
                          ~ sma(dm_g ~ individual_count, log = "xy", data = .x)),
         sma_log10_plots = map2(.x = sma_log10_object,
                         .y = taxa_clean,
                         .f = ~ plot(.x, xlab = "individual count", ylab = "dry mass (g)", main = .y)))
         
taxa_nested_sma_log10_plot$sma_log10_object
```

### Checking assumptions again

#### Homogeneity of variance

```{r}
taxa_nested_sma_log10_plot_fitted_resid <- taxa_nested_sma_log10_plot |> 
  mutate(fitted_resid = map(.x = sma_log10_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0, linetype = 2) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_sma_log10_plot_fitted_resid$fitted_resid_plot
```

#### Normality

```{r}
taxa_nested_sma_log10_plot_fitted_resid_qq <- taxa_nested_sma_log10_plot_fitted_resid |>
  mutate(qq = map2(.x = sma_log10_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
```

### Regression summary statistics

Pulling out regression summary statistics

```{r}
# Getting coefficients from SMA
taxa_nested_sma_log10_plot_coef <- taxa_nested_sma_log10_plot |>
  mutate(summary = map(.x = sma_log10_object,
                       .f = ~ (smatr:::summary.sma(.x))))

long_summary <- taxa_nested_sma_log10_plot_coef |> 
  select(taxa_clean, summary) |> 
  unnest(summary) |> 
  select(taxa_clean, n, r2, pval, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI)

# Back-transforming intercept and confidence intervals to get parameter 'a' in power equation: y = ax^b
long_summary_a <- long_summary |> 
  mutate(a = 10^Int,
         a_low_ci = 10^Int_lowCI,
         a_high_ci = 10^Int_highCI)
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).

```{r}
taxa_nested_sma_log10_plot_coef_sf <- taxa_nested_sma_log10_plot_coef |>
  mutate(sf = map(.x = sma_log10_object,
                  .f = ~ (1/length(residuals(.x)))*sum(10^residuals(.x))))

taxa_sf <- taxa_nested_sma_log10_plot_coef_sf |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to SMA summary table
long_summary_a_sf <- merge(long_summary_a, taxa_sf)

# Saving the regression summary
write_csv(long_summary_a_sf,
          here("output/frozen/count_dm/biomass_regression_summary_frozen_count_dm.csv"))
```

### Back-transformation 

Plotting back-transformed regression line with smearing factor correction and 95% confidence band

```{r}
taxa_nested_sma_log10_plot_coef_BT <- taxa_nested_sma_log10_plot_coef_sf |> 
  unnest(c(data, summary, sf)) |>
  mutate(lower_CI_line = (10^Int_lowCI)*(individual_count^Slope_lowCI)*sf,
         upper_CI_line = (10^Int_highCI)*(individual_count^Slope_highCI)*sf) |>
  nest(data = c(individual_count, dm_g, lower_CI_line, upper_CI_line, keep_data)) |>
  select(taxa_clean, data, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI, sf, r2) |>
  mutate(BT_plot = pmap(.l = list(data, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI, sf,
                                  taxa_clean, r2),
                        .f = ~ggplot(..1, aes(x = individual_count, y = dm_g)) +
                          geom_point(fill = "grey", size = 3, alpha = 0.5, stroke = 1) +
                          geom_function(fun = function(x) (10^..5)*(x^..2)*..8, 
                                        col = "darkgreen", linewidth  = 1) +
                          geom_ribbon(aes(ymin = lower_CI_line, ymax = upper_CI_line), fill = "darkgreen", 
                                      alpha = 0.2) +
                          ggtitle(..9) + 
                          labs(x = "individual count", y = "dry mass (g)") + 
                          geom_text(x = 0.25*max(..1$individual_count), y = 0.85*max(..1$dm_g), 
                                    label = deparse(bquote(paste("D = ", .(round((10^..5), digits = 2)), 
                                                                 "C" ^.(round(..2, digits = 2)),
                                                                 .(round(..8, digits = 2)), ",  R"^2, 
                                                                 " = ", .(round(..10, digits = 2)), sep = ""))),
                                    parse = TRUE, size = 4) +
                          theme_bw() + 
                          theme(panel.border = element_blank(), 
                                panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank(), 
                                axis.line = element_line(colour = "black"),
                                axis.text = element_text(size = 12, colour = "black"), 
                                axis.title = element_text(size = 14), 
                                title = element_text(size = 16)) + 
                          scale_x_continuous(expand = expansion(mult = c(0, 0.1))) + 
                          scale_y_continuous(expand = expansion(mult = c(0, 0.1)))))
taxa_nested_sma_log10_plot_coef_BT$BT_plot
```

### Calculating biomass ratios and associated summary statistics

```{r}
biomass_frozen_count_dm_cleaned_ratios <- biomass_frozen_count_dm_cleaned |>
  mutate(dm_count = dm_g/individual_count) |>
  group_by(taxa_clean) |>
  summarise(n = n(),
            mean_dm_count = mean(dm_count),
            sd_dm_count = sd(dm_count),
            lower_ci_mean_dm_count = mean_dm_count-0.95*(sd_dm_count/sqrt(n)),
            upper_ci_mean_dm_count = mean_dm_count+0.95*(sd_dm_count/sqrt(n)),
            geom_mean = prod(dm_count)^(1/n),
            min_dm_count = min(dm_count),
            median_dm_count = median(dm_count),
            max_dm_count = max(dm_count))

# Saving the ratio summary
write_csv(biomass_frozen_count_dm_cleaned_ratios,
          here("output/frozen/count_dm/biomass_ratio_summary_frozen_count_dm.csv"))
```

## Excluding outlier candidates

### Running SMA's on log10-transformed data and plotting

```{r}
taxa_nested_outliers_removed_sma_log10_plot <- biomass_frozen_count_dm_cleaned |> 
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(sma_log10_object = map(.x = data,
                          ~ sma(dm_g ~ individual_count, log = "xy", data = .x)),
         sma_log10_plots = map2(.x = sma_log10_object,
                         .y = taxa_clean,
                         .f = ~ plot(.x, xlab = "individual count", ylab = "dry mass (g)", main = .y)))
taxa_nested_sma_log10_plot$sma_log10_plots
```

### Checking assumptions again

#### Homogeneity of variance

```{r}
taxa_nested_outliers_removed_sma_log10_plot_fitted_resid <- taxa_nested_outliers_removed_sma_log10_plot |> 
  mutate(fitted_resid = map(.x = sma_log10_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0, linetype = 2) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_outliers_removed_sma_log10_plot_fitted_resid$fitted_resid_plot
```

#### Normality

```{r}
taxa_nested_outliers_removed_sma_log10_plot_fitted_resid_qq <- taxa_nested_outliers_removed_sma_log10_plot_fitted_resid |>
  mutate(qq = map2(.x = sma_log10_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
taxa_nested_outliers_removed_sma_log10_plot_fitted_resid_qq$qq
```

### Regression summary statistics

Pulling out regression summary statistics

```{r}
# Getting coefficients from SMA
taxa_nested_outliers_removed_sma_log10_plot_coef <- taxa_nested_outliers_removed_sma_log10_plot |>
  mutate(summary = map(.x = sma_log10_object,
                       .f = ~ (smatr:::summary.sma(.x))))

long_summary_outliers_removed <- taxa_nested_outliers_removed_sma_log10_plot_coef |> 
  select(taxa_clean, summary) |> 
  unnest(summary) |> 
  select(taxa_clean, n, r2, pval, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI)

# Back-transforming intercept and confidence intervals to get parameter 'a' in power equation: y = ax^b
long_summary_a_outliers_removed <- long_summary_outliers_removed |> 
  mutate(a = 10^Int,
         a_low_ci = 10^Int_lowCI,
         a_high_ci = 10^Int_highCI)
```

Calculating SF (smearing factor - mean of back-transformed residuals) as per Mährlein, M., M. Pätzig, M. Brauns and A. M. Dolman. Length–mass relationships for lake macroinvertebrates corrected for back-transformation and preservation effects. Hydrobiologia, 768, 37-50 (2016).3

```{r}
taxa_nested_outliers_removed_sma_log10_plot_coef_sf <- taxa_nested_outliers_removed_sma_log10_plot_coef |>
  mutate(sf = map(.x = sma_log10_object,
                  .f = ~ (1/length(residuals(.x)))*sum(10^residuals(.x))))

taxa_sf_outliers_removed <- taxa_nested_outliers_removed_sma_log10_plot_coef_sf |>
  select(taxa_clean, sf) |>
  unnest(sf)

# Adding smearing factor to SMA summary table
long_summary_a_sf_outliers_removed <- merge(long_summary_a_outliers_removed, taxa_sf_outliers_removed)

# Saving the regression summary
write_csv(long_summary_a_sf_outliers_removed,
          here("output/frozen/count_dm/biomass_regression_summary_frozen_count_dm_outliers_removed.csv"))
```

### Back-transformation 

Plotting back-transformed regression line with smearing factor correction and 95% confidence band

```{r}
taxa_nested_outliers_removed_sma_log10_plot_coef_sf_BT <- taxa_nested_outliers_removed_sma_log10_plot_coef_sf |> 
  unnest(c(data, summary, sf)) |>
  mutate(lower_CI_line = (10^Int_lowCI)*(individual_count^Slope_lowCI)*sf,
         upper_CI_line = (10^Int_highCI)*(individual_count^Slope_highCI)*sf) |>
  nest(data = c(individual_count, dm_g, lower_CI_line, upper_CI_line, keep_data)) |>
  select(taxa_clean, data, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI, sf, r2) |>
  mutate(BT_plot = pmap(.l = list(data, Slope, Slope_lowCI, Slope_highCI, Int, Int_lowCI, Int_highCI, sf,
                                  taxa_clean, r2),
                        .f = ~ggplot(..1, aes(x = individual_count, y = dm_g)) +
                          geom_point(fill = "grey", size = 3, alpha = 0.5, stroke = 1) +
                          geom_function(fun = function(x) (10^..5)*(x^..2)*..8, 
                                        col = "darkgreen", linewidth  = 1) +
                          geom_ribbon(aes(ymin = lower_CI_line, ymax = upper_CI_line), fill = "darkgreen", 
                                      alpha = 0.2) +
                          ggtitle(..9) + 
                          labs(x = "individual count", y = "dry mass (g)") + 
                          geom_text(x = 0.25*max(..1$individual_count), y = 0.85*max(..1$dm_g), 
                                    label = deparse(bquote(paste("D = ", .(round((10^..5), digits = 2)), 
                                                                 "C" ^.(round(..2, digits = 2)),
                                                                 .(round(..8, digits = 2)), ",  R"^2, 
                                                                 " = ", .(round(..10, digits = 2)), sep = ""))),
                                    parse = TRUE, size = 4) +
                          theme_bw() + 
                          theme(panel.border = element_blank(), 
                                panel.grid.major = element_blank(),
                                panel.grid.minor = element_blank(), 
                                axis.line = element_line(colour = "black"),
                                axis.text = element_text(size = 12, colour = "black"), 
                                axis.title = element_text(size = 14), 
                                title = element_text(size = 16)) + 
                          scale_x_continuous(expand = expansion(mult = c(0, 0.1))) + 
                          scale_y_continuous(expand = expansion(mult = c(0, 0.1)))))
taxa_nested_outliers_removed_sma_log10_plot_coef_sf_BT$BT_plot
```

### Calculating biomass ratios and associated summary statistics

```{r}
biomass_frozen_count_dm_outliers_removed_ratios <- biomass_frozen_count_dm_cleaned |>
  filter(keep_data == TRUE) |>
  mutate(dm_count = dm_g/individual_count) |>
  group_by(taxa_clean) |>
  summarise(n = n(),
            mean_dm_count = mean(dm_count),
            sd_dm_count = sd(dm_count),
            lower_ci_mean_dm_count = mean_dm_count-0.95*(sd_dm_count/sqrt(n)),
            upper_ci_mean_dm_count = mean_dm_count+0.95*(sd_dm_count/sqrt(n)),
            geom_mean = prod(dm_count)^(1/n),
            min_dm_count = min(dm_count),
            median_dm_count = median(dm_count),
            max_dm_count = max(dm_count))

# Saving the ratio summary
write_csv(biomass_frozen_count_dm_outliers_removed_ratios,
          here("output/frozen/count_dm/biomass_ratio_summary_frozen_count_dm_outliers_removed.csv"))
```
