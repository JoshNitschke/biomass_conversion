---
title: "regression_analysis"
author: "Josh Nitschke"
date: "2023-08-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install.packages("remotes")
remotes::install_github("traitecoevo/smatr")

library(tidyverse)
library(here)
library(smatr)
library(janitor)
library(skimr)
library(gridExtra)
library(olsrr)
library(purrr)
library(tidyr)
```

## read in processed data
```{r}
biomass_frozen_outliers_identified <- read_csv(here("data/processed/biomass_frozen_outliers_identified.csv"))
```

## running SMA's on untransformed data
```{r}
taxa_nested_sma <- biomass_frozen_outliers_identified |> 
  group_nest(taxa_clean) |>
  mutate(sma_object = map(.x = data,
                          ~ sma(dm_g ~ wm_g, data = .x)))

```

### Check assumptions

#### homogeneity of variance
```{r}
taxa_nested_sma_fitted_resid <- taxa_nested_sma |> 
  mutate(fitted_resid = map(.x = sma_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_sma_fitted_resid$fitted_resid_plot

```

#### Normality
```{r}
taxa_nested_sma_fitted_resid_qq <- taxa_nested_sma_fitted_resid |>
  mutate(qq = map2(.x = sma_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
```
# Excluding outliers
## running SMA's on untransformed data
```{r}
taxa_nested_sma_outliers_removed <- biomass_frozen_outliers_identified |> 
  filter(keep_data == TRUE) |>
  group_nest(taxa_clean) |>
  mutate(sma_object = map(.x = data,
                          ~ sma(dm_g ~ wm_g, data = .x)))

```

### Check assumptions

#### homogeneity of variance
```{r}
taxa_nested_sma_outliers_removed_fitted_resid <- taxa_nested_sma_outliers_removed |> 
  mutate(fitted_resid = map(.x = sma_object,
                             .f = ~ tibble(fitted = fitted(.x), residuals = residuals(.x))),
         fitted_resid_plot = map2(.x = fitted_resid,
                     .y = taxa_clean,
                     .f = ~ ggplot(data = .x, aes(x = fitted, y = residuals)) + 
                       ggtitle(.y) +
                       labs(x = "fitted value", y = "residual") +
                       geom_point() + 
                       geom_hline(yintercept = 0) +
                       theme_bw() + 
                       theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
                       axis.text = element_text(size = 12, colour = "black"), axis.title = element_text(size = 14))))
taxa_nested_sma_outliers_removed_fitted_resid$fitted_resid_plot

```

#### Normality
```{r}
taxa_nested_sma_outliers_removed_fitted_resid_qq <- taxa_nested_sma_outliers_removed_fitted_resid |>
  mutate(qq = map2(.x = sma_object,
                  .y = taxa_clean,
                  .f = ~ plot(.x, which = "qq", main = paste("qq-plot:",.y))))
```


## running SMA's
```{r}
taxa_sma <- taxa_nested |> 
  mutate(sma_object = map(.x = data,
                         ~ sma(dm_g ~ wm_g, data = .x)))
  )

#testing with lm first
lm_fun <- function(x, y){ggplot(taxa_sma, aes(x = .data[[x]], y= .data[[y]])) +
  geom_point(alpha = 0.50) + stat_smooth(method = "lm")}
  
lm_fun(x = "wm_g", y = "dm_g")

```